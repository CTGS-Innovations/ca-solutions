##
## Computer Ally — WordPress Development Stack
##
## WordPress :  http://localhost:20200
## phpMyAdmin:  http://localhost:20300
##
## Managed via: ./wp-manage.sh
##

services:
  db:
    image: mariadb:11
    container_name: ca-wp-db
    restart: unless-stopped
    environment:
      MARIADB_DATABASE: computerally
      MARIADB_USER: wp
      MARIADB_PASSWORD: wp_dev_2025
      MARIADB_ROOT_PASSWORD: root_dev_2025
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  wordpress:
    image: wordpress:6.7-php8.3-apache
    container_name: ca-wp-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "20200:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_NAME: computerally
      WORDPRESS_DB_USER: wp
      WORDPRESS_DB_PASSWORD: wp_dev_2025
      WORDPRESS_TABLE_PREFIX: wp_
      WORDPRESS_DEBUG: "1"
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', false);
        define('SCRIPT_DEBUG', true);
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '512M');

        /* ── Cloudflare Tunnel / Reverse Proxy Support ──────── */

        // Trust X-Forwarded-Proto from Cloudflare to detect HTTPS
        if (
            isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) &&
            $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https'
        ) {
            $$_SERVER['HTTPS'] = 'on';
        }

        // Trust X-Forwarded-For for real client IP
        if (isset($$_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $$ips = explode(',', $$_SERVER['HTTP_X_FORWARDED_FOR']);
            $$_SERVER['REMOTE_ADDR'] = trim($$ips[0]);
        }

        // Dynamic site URL — works both locally and via Cloudflare Tunnel
        if (isset($$_SERVER['HTTP_HOST'])) {
            $$scheme = (isset($$_SERVER['HTTPS']) && $$_SERVER['HTTPS'] === 'on') ? 'https' : 'http';
            $$host   = $$_SERVER['HTTP_HOST'];
            define('WP_HOME',    $$scheme . '://' . $$host);
            define('WP_SITEURL', $$scheme . '://' . $$host);
        }

        // Allow Cloudflare to serve over HTTPS while origin is HTTP
        define('FORCE_SSL_ADMIN', false);
    volumes:
      - wp_data:/var/www/html
      # Mount child theme and plugin directly from this repo — live edits
      - ./theme/computerally-child:/var/www/html/wp-content/themes/computerally-child
      - ./plugin/computer-ally-core:/var/www/html/wp-content/plugins/computer-ally-core

  phpmyadmin:
    image: phpmyadmin:5
    container_name: ca-wp-pma
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "20300:80"
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: root_dev_2025
      UPLOAD_LIMIT: 100M

  wpcli:
    image: wordpress:cli-php8.3
    container_name: ca-wp-cli
    depends_on:
      db:
        condition: service_healthy
    user: "33:33"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_NAME: computerally
      WORDPRESS_DB_USER: wp
      WORDPRESS_DB_PASSWORD: wp_dev_2025
    volumes:
      - wp_data:/var/www/html
      - ./theme/computerally-child:/var/www/html/wp-content/themes/computerally-child
      - ./plugin/computer-ally-core:/var/www/html/wp-content/plugins/computer-ally-core
    profiles: ["cli"]
    entrypoint: wp
    command: "--info"

volumes:
  db_data:
    name: ca-wp-db-data
  wp_data:
    name: ca-wp-data
